import X,{Fragment as se,createContext as z,createRef as be,useCallback as de,useContext as ee,useMemo as I,useReducer as ce,useRef as D}from"react";import{useComputed as J}from'../../hooks/use-computed.js';import{useDisposables as oe}from'../../hooks/use-disposables.js';import{useEvent as x}from'../../hooks/use-event.js';import{useId as j}from'../../hooks/use-id.js';import{useIsoMorphicEffect as h}from'../../hooks/use-iso-morphic-effect.js';import{useLatestValue as fe}from'../../hooks/use-latest-value.js';import{useOutsideClick as me}from'../../hooks/use-outside-click.js';import{useResolveButtonType as Te}from'../../hooks/use-resolve-button-type.js';import{useSyncRefs as H}from'../../hooks/use-sync-refs.js';import{useTreeWalker as xe}from'../../hooks/use-tree-walker.js';import{calculateActiveIndex as ge,Focus as R}from'../../utils/calculate-active-index.js';import{disposables as te}from'../../utils/disposables.js';import{forwardRefWithAs as k,render as w,compact as Oe,Features as ne}from'../../utils/render.js';import{isDisabledReactIssue7711 as Ce}from'../../utils/bugs.js';import{match as B}from'../../utils/match.js';import{objectToFormEntries as Re}from'../../utils/form.js';import{sortByDomNode as ve}from'../../utils/focus-management.js';import{Hidden as ye,Features as Se}from'../../internal/hidden.js';import{useOpenClosed as Ae,State as q,OpenClosedProvider as Pe}from'../../internal/open-closed.js';import{Keys as v}from'../keyboard.js';import{useControllable as Ee}from'../../hooks/use-controllable.js';import{useWatch as Ie}from'../../hooks/use-watch.js';var De=(n=>(n[n.Open=0]="Open",n[n.Closed=1]="Closed",n))(De||{}),Le=(n=>(n[n.Single=0]="Single",n[n.Multi=1]="Multi",n))(Le||{}),he=(n=>(n[n.Pointer=0]="Pointer",n[n.Other=1]="Other",n))(he||{}),Ve=(a=>(a[a.OpenCombobox=0]="OpenCombobox",a[a.CloseCombobox=1]="CloseCombobox",a[a.GoToOption=2]="GoToOption",a[a.RegisterOption=3]="RegisterOption",a[a.UnregisterOption=4]="UnregisterOption",a[a.RegisterLabel=5]="RegisterLabel",a))(Ve||{});function Q(t,l=n=>n){let n=t.activeOptionIndex!==null?t.options[t.activeOptionIndex]:null,e=ve(l(t.options.slice()),r=>r.dataRef.current.domRef.current),i=n?e.indexOf(n):null;return i===-1&&(i=null),{options:e,activeOptionIndex:i}}let Me={[1](t){return t.dataRef.current.disabled||t.comboboxState===1?t:{...t,activeOptionIndex:null,comboboxState:1}},[0](t){if(t.dataRef.current.disabled||t.comboboxState===0)return t;let l=t.activeOptionIndex,{isSelected:n}=t.dataRef.current,e=t.options.findIndex(i=>n(i.dataRef.current.value));return e!==-1&&(l=e),{...t,comboboxState:0,activeOptionIndex:l}},[2](t,l){var i;if(t.dataRef.current.disabled||t.dataRef.current.optionsRef.current&&!t.dataRef.current.optionsPropsRef.current.static&&t.comboboxState===1)return t;let n=Q(t);if(n.activeOptionIndex===null){let r=n.options.findIndex(a=>!a.dataRef.current.disabled);r!==-1&&(n.activeOptionIndex=r)}let e=ge(l,{resolveItems:()=>n.options,resolveActiveIndex:()=>n.activeOptionIndex,resolveId:r=>r.id,resolveDisabled:r=>r.dataRef.current.disabled});return{...t,...n,activeOptionIndex:e,activationTrigger:(i=l.trigger)!=null?i:1}},[3]:(t,l)=>{let n={id:l.id,dataRef:l.dataRef},e=Q(t,r=>[...r,n]);t.activeOptionIndex===null&&t.dataRef.current.isSelected(l.dataRef.current.value)&&(e.activeOptionIndex=e.options.indexOf(n));let i={...t,...e,activationTrigger:1};return t.dataRef.current.__demoMode&&t.dataRef.current.value===void 0&&(i.activeOptionIndex=0),i},[4]:(t,l)=>{let n=Q(t,e=>{let i=e.findIndex(r=>r.id===l.id);return i!==-1&&e.splice(i,1),e});return{...t,...n,activationTrigger:1}},[5]:(t,l)=>({...t,labelId:l.id})},Y=z(null);Y.displayName="ComboboxActionsContext";function K(t){let l=ee(Y);if(l===null){let n=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,K),n}return l}let Z=z(null);Z.displayName="ComboboxDataContext";function U(t){let l=ee(Z);if(l===null){let n=new Error(`<${t} /> is missing a parent <Combobox /> component.`);throw Error.captureStackTrace&&Error.captureStackTrace(n,U),n}return l}function Fe(t,l){return B(l.type,Me,t,l)}let _e=se;function ke(t,l){let{value:n,defaultValue:e,onChange:i,name:r,by:a=(d,f)=>d===f,disabled:m=!1,__demoMode:o=!1,nullable:s=!1,multiple:y=!1,...C}=t,[g,O]=Ee(n,i,e),[c,b]=ce(Fe,{dataRef:be(),comboboxState:o?0:1,options:[],activeOptionIndex:null,activationTrigger:1,labelId:null}),T=D(!1),G=D({static:!1,hold:!1}),V=D(null),M=D(null),N=D(null),W=D(null),P=x(typeof a=="string"?(d,f)=>{let A=a;return(d==null?void 0:d[A])===(f==null?void 0:f[A])}:a),F=de(d=>B(u.mode,{[1]:()=>g.some(f=>P(f,d)),[0]:()=>P(g,d)}),[g]),u=I(()=>({...c,optionsPropsRef:G,labelRef:V,inputRef:M,buttonRef:N,optionsRef:W,value:g,disabled:m,mode:y?1:0,get activeOptionIndex(){if(T.current&&c.activeOptionIndex===null&&c.options.length>0){let d=c.options.findIndex(f=>!f.dataRef.current.disabled);if(d!==-1)return d}return c.activeOptionIndex},compare:P,isSelected:F,nullable:s,__demoMode:o}),[g,m,y,s,o,c]);h(()=>{c.dataRef.current=u},[u]),me([u.buttonRef,u.inputRef,u.optionsRef],()=>b({type:1}),u.comboboxState===0);let E=I(()=>({open:u.comboboxState===0,disabled:m,activeIndex:u.activeOptionIndex,activeOption:u.activeOptionIndex===null?null:u.options[u.activeOptionIndex].dataRef.current.value,value:g}),[u,m,g]),p=x(d=>{let f=u.options.find(A=>A.id===d);!f||$(f.dataRef.current.value)}),S=x(()=>{if(u.activeOptionIndex!==null){let{dataRef:d,id:f}=u.options[u.activeOptionIndex];$(d.current.value),b({type:2,focus:R.Specific,id:f})}}),L=x(()=>{b({type:0}),T.current=!0}),_=x(()=>{b({type:1}),T.current=!1}),re=x((d,f,A)=>(T.current=!1,d===R.Specific?b({type:2,focus:R.Specific,id:f,trigger:A}):b({type:2,focus:d,trigger:A}))),ae=x((d,f)=>(b({type:3,id:d,dataRef:f}),()=>b({type:4,id:d}))),le=x(d=>(b({type:5,id:d}),()=>b({type:5,id:null}))),$=x(d=>B(u.mode,{[0](){return O==null?void 0:O(d)},[1](){let f=u.value.slice(),A=f.findIndex(pe=>P(pe,d));return A===-1?f.push(d):f.splice(A,1),O==null?void 0:O(f)}})),ie=I(()=>({onChange:$,registerOption:ae,registerLabel:le,goToOption:re,closeCombobox:_,openCombobox:L,selectActiveOption:S,selectOption:p}),[]),ue=l===null?{}:{ref:l};return X.createElement(Y.Provider,{value:ie},X.createElement(Z.Provider,{value:u},X.createElement(Pe,{value:B(u.comboboxState,{[0]:q.Open,[1]:q.Closed})},r!=null&&g!=null&&Re({[r]:g}).map(([d,f])=>X.createElement(ye,{features:Se.Hidden,...Oe({key:d,as:"input",type:"hidden",hidden:!0,readOnly:!0,name:d,value:f})})),w({ourProps:ue,theirProps:C,slot:E,defaultTag:_e,name:"Combobox"}))))}let we=k(ke),Be="input",Ue=k(function(l,n){var u,E;let{value:e,onChange:i,displayValue:r,type:a="text",...m}=l,o=U("Combobox.Input"),s=K("Combobox.Input"),y=H(o.inputRef,n),C=`headlessui-combobox-input-${j()}`,g=oe(),O=!1;function c(p){var _;let S=o.inputRef.current;if(!S||S.value===p)return;let L=Object.getOwnPropertyDescriptor(S.constructor.prototype,"value");(_=L==null?void 0:L.set)==null||_.call(S,p),O=!0,S.dispatchEvent(new Event("input",{bubbles:!0})),S.value=p,O=!1}let b=I(()=>{var p;return typeof r=="function"?(p=r(o.value))!=null?p:"":typeof o.value=="string"?o.value:""},[o.value]);Ie(([p,S],[L,_])=>{!o.inputRef.current||(_===0&&S===1?c(p):p!==L&&(o.inputRef.current.value=p))},[b,o.comboboxState]);let T=D(!1),G=x(()=>{T.current=!0}),V=x(()=>{setTimeout(()=>{T.current=!1})}),M=x(p=>{switch(p.key){case v.Backspace:case v.Delete:if(o.mode!==0||!o.nullable)return;let S=p.currentTarget;g.requestAnimationFrame(()=>{S.value===""&&(s.onChange(null),o.optionsRef.current&&(o.optionsRef.current.scrollTop=0),s.goToOption(R.Nothing))});break;case v.Enter:if(o.comboboxState!==0||T.current)return;if(p.preventDefault(),p.stopPropagation(),o.activeOptionIndex===null){s.closeCombobox();return}s.selectActiveOption(),o.mode===0&&s.closeCombobox();break;case v.ArrowDown:return p.preventDefault(),p.stopPropagation(),B(o.comboboxState,{[0]:()=>{s.goToOption(R.Next)},[1]:()=>{s.openCombobox()}});case v.ArrowUp:return p.preventDefault(),p.stopPropagation(),B(o.comboboxState,{[0]:()=>{s.goToOption(R.Previous)},[1]:()=>{s.openCombobox(),g.nextFrame(()=>{o.value||s.goToOption(R.Last)})}});case v.Home:case v.PageUp:return p.preventDefault(),p.stopPropagation(),s.goToOption(R.First);case v.End:case v.PageDown:return p.preventDefault(),p.stopPropagation(),s.goToOption(R.Last);case v.Escape:return o.comboboxState!==0?void 0:(p.preventDefault(),o.optionsRef.current&&!o.optionsPropsRef.current.static&&p.stopPropagation(),s.closeCombobox());case v.Tab:if(o.comboboxState!==0)return;o.mode===0&&s.selectActiveOption(),s.closeCombobox();break}}),N=x(p=>{O||s.openCombobox(),i==null||i(p)}),W=J(()=>{if(!!o.labelId)return[o.labelId].join(" ")},[o.labelId]),P=I(()=>({open:o.comboboxState===0,disabled:o.disabled}),[o]),F={ref:y,id:C,role:"combobox",type:a,"aria-controls":(u=o.optionsRef.current)==null?void 0:u.id,"aria-expanded":o.disabled?void 0:o.comboboxState===0,"aria-activedescendant":o.activeOptionIndex===null||(E=o.options[o.activeOptionIndex])==null?void 0:E.id,"aria-multiselectable":o.mode===1?!0:void 0,"aria-labelledby":W,disabled:o.disabled,onCompositionStart:G,onCompositionEnd:V,onKeyDown:M,onChange:N};return w({ourProps:F,theirProps:m,slot:P,defaultTag:Be,name:"Combobox.Input"})}),Ge="button",Ne=k(function(l,n){var c;let e=U("Combobox.Button"),i=K("Combobox.Button"),r=H(e.buttonRef,n),a=`headlessui-combobox-button-${j()}`,m=oe(),o=x(b=>{switch(b.key){case v.ArrowDown:return b.preventDefault(),b.stopPropagation(),e.comboboxState===1&&i.openCombobox(),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})});case v.ArrowUp:return b.preventDefault(),b.stopPropagation(),e.comboboxState===1&&(i.openCombobox(),m.nextFrame(()=>{e.value||i.goToOption(R.Last)})),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})});case v.Escape:return e.comboboxState!==0?void 0:(b.preventDefault(),e.optionsRef.current&&!e.optionsPropsRef.current.static&&b.stopPropagation(),i.closeCombobox(),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})}));default:return}}),s=x(b=>{if(Ce(b.currentTarget))return b.preventDefault();e.comboboxState===0?i.closeCombobox():(b.preventDefault(),i.openCombobox()),m.nextFrame(()=>{var T;return(T=e.inputRef.current)==null?void 0:T.focus({preventScroll:!0})})}),y=J(()=>{if(!!e.labelId)return[e.labelId,a].join(" ")},[e.labelId,a]),C=I(()=>({open:e.comboboxState===0,disabled:e.disabled,value:e.value}),[e]),g=l,O={ref:r,id:a,type:Te(l,e.buttonRef),tabIndex:-1,"aria-haspopup":!0,"aria-controls":(c=e.optionsRef.current)==null?void 0:c.id,"aria-expanded":e.disabled?void 0:e.comboboxState===0,"aria-labelledby":y,disabled:e.disabled,onClick:s,onKeyDown:o};return w({ourProps:O,theirProps:g,slot:C,defaultTag:Ge,name:"Combobox.Button"})}),je="label",He=k(function(l,n){let e=U("Combobox.Label"),i=`headlessui-combobox-label-${j()}`,r=K("Combobox.Label"),a=H(e.labelRef,n);h(()=>r.registerLabel(i),[i]);let m=x(()=>{var C;return(C=e.inputRef.current)==null?void 0:C.focus({preventScroll:!0})}),o=I(()=>({open:e.comboboxState===0,disabled:e.disabled}),[e]);return w({ourProps:{ref:a,id:i,onClick:m},theirProps:l,slot:o,defaultTag:je,name:"Combobox.Label"})}),Ke="ul",We=ne.RenderStrategy|ne.Static,Xe=k(function(l,n){var O;let{hold:e=!1,...i}=l,r=U("Combobox.Options"),a=H(r.optionsRef,n),m=`headlessui-combobox-options-${j()}`,o=Ae(),s=(()=>o!==null?o===q.Open:r.comboboxState===0)();h(()=>{var c;r.optionsPropsRef.current.static=(c=l.static)!=null?c:!1},[r.optionsPropsRef,l.static]),h(()=>{r.optionsPropsRef.current.hold=e},[r.optionsPropsRef,e]),xe({container:r.optionsRef.current,enabled:r.comboboxState===0,accept(c){return c.getAttribute("role")==="option"?NodeFilter.FILTER_REJECT:c.hasAttribute("role")?NodeFilter.FILTER_SKIP:NodeFilter.FILTER_ACCEPT},walk(c){c.setAttribute("role","none")}});let y=J(()=>{var c,b;return(b=r.labelId)!=null?b:(c=r.buttonRef.current)==null?void 0:c.id},[r.labelId,r.buttonRef.current]),C=I(()=>({open:r.comboboxState===0}),[r]),g={"aria-activedescendant":r.activeOptionIndex===null||(O=r.options[r.activeOptionIndex])==null?void 0:O.id,"aria-labelledby":y,role:"listbox",id:m,ref:a};return w({ourProps:g,theirProps:i,slot:C,defaultTag:Ke,features:We,visible:s,name:"Combobox.Options"})}),$e="li",Je=k(function(l,n){var P,F;let{disabled:e=!1,value:i,...r}=l,a=U("Combobox.Option"),m=K("Combobox.Option"),o=`headlessui-combobox-option-${j()}`,s=a.activeOptionIndex!==null?a.options[a.activeOptionIndex].id===o:!1,y=a.isSelected(i),C=D(null),g=fe({disabled:e,value:i,domRef:C,textValue:(F=(P=C.current)==null?void 0:P.textContent)==null?void 0:F.toLowerCase()}),O=H(n,C),c=x(()=>m.selectOption(o));h(()=>m.registerOption(o,g),[g,o]);let b=D(!a.__demoMode);h(()=>{if(!a.__demoMode)return;let u=te();return u.requestAnimationFrame(()=>{b.current=!0}),u.dispose},[]),h(()=>{if(a.comboboxState!==0||!s||!b.current||a.activationTrigger===0)return;let u=te();return u.requestAnimationFrame(()=>{var E,p;(p=(E=C.current)==null?void 0:E.scrollIntoView)==null||p.call(E,{block:"nearest"})}),u.dispose},[C,s,a.comboboxState,a.activationTrigger,a.activeOptionIndex]);let T=x(u=>{if(e)return u.preventDefault();c(),a.mode===0&&m.closeCombobox()}),G=x(()=>{if(e)return m.goToOption(R.Nothing);m.goToOption(R.Specific,o)}),V=x(()=>{e||s||m.goToOption(R.Specific,o,0)}),M=x(()=>{e||!s||a.optionsPropsRef.current.hold||m.goToOption(R.Nothing)}),N=I(()=>({active:s,selected:y,disabled:e}),[s,y,e]);return w({ourProps:{id:o,ref:O,role:"option",tabIndex:e===!0?void 0:-1,"aria-disabled":e===!0?!0:void 0,"aria-selected":y,disabled:void 0,onClick:T,onFocus:G,onPointerMove:V,onMouseMove:V,onPointerLeave:M,onMouseLeave:M},theirProps:r,slot:N,defaultTag:$e,name:"Combobox.Option"})}),Lo=Object.assign(we,{Input:Ue,Button:Ne,Label:He,Options:Xe,Option:Je});export{Lo as Combobox};
